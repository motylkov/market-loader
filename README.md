# Market Loader

Утилиты загрузки данных с API Т-Инвестиций для анализа рынка ценных бумаг

## Описание

Данный набор утилит предназначен для автоматизированной загрузки рыночных данных (свечей) с API Т-Инвестиций и их хранения в локальной базе данных. Программы позволяют гибко настраивать частоту обновления данных и объём хранимой информации в зависимости от ваших задач: от высокочастотного анализа до долгосрочного мониторинга.


Поддерживается загрузка:

- **Инструменты** - акции, облигации, ETF
- **Свечи** - исторические данные по различным временным интервалам
- **Дивиденды** - информация о выплатах по акциям

## Возможности

### Загрузчики данных

1. **loader-instruments** - Инициализация структуры базы данных и загрузка справочника доступных финансовых инструментов:
   - Акции, облигации, ETF
   - Фильтрация по статусу торговли
   - Автоматическое обновление списка

>**Важно:**
>
>Запустите loader-instruments в первую очередь - он создаст необходимые таблицы и заполнит таблицу instruments.
>
>**По умолчанию все инструменты отключены (enabled = false)** для предотвращения загрузки больших объемов данных.
>
>**Включите только нужные инструменты** перед запуском загрузчиков свечей:
>```sql
>-- Пример: включить конкретные тикеры
>UPDATE instruments SET enabled = true 
>WHERE ticker IN ('SBER', 'GAZP', 'LKOH');
>```
>
>Подробные примеры в файле `scripts/instruments.sql`
>
>При повторном запуске скрипт добавит все отсутствующие инструменты (с enabled = false).

2. **loader-dividends** - Загружает данные о дивидендах
   - Информация о выплатах по акциям
   - Даты объявления и выплат
   - Размер дивидендов и доходность

3. **Загрузчики свечей** - Загружают исторические данные* по временным интервалам:
   - 1, 2, 3, 5, 10, 15, 30 минут
   - 1, 2, 4 часа
   - 1 день, 1 неделя, 1 месяц
   - Загружают данные только для включенных инструментов (enabled = true)

4. **loader-arch** - Быстрая загрузка исторических минутных данных через архивы:
   - Загружает данные за большой период автоматически обрабатывая ZIP-архивы с CSV файлами
   - Значительно быстрее обычных загрузчиков для больших объемов
   - Использует T-Invest API `/history-data` endpoint
   - Автоматически делает повторные попытки при ошибках API (до 3 раз)
   - Настраивается через `start_date` в конфигурации (учитывается указанный год)
   - Соблюдает лимит в API (`rate_limit_pause`)
   - Загружает данные только для включенных инструментов (enabled = true)

5. **loader-cli** - CLI-загрузчик свечей с параметрами командной строки:
   - Флаги: `--interval|-i`, `--figi|-f`, `--start-date|-s`, `--conf|-c`
   - Примеры:
     - `loader-cli --figi BBG000B9XRY4 --interval 1min`
     - `loader-cli -f BBG000B9XRY4 -i 1hour -s 2024-01-01 -c config/config.yaml`
   - Если задан `--figi|-f` - то загружает его данные вне зависимости от `enabled`
   - Загружает данные для включенных инструментов (enabled = true) по умолчанию

### База данных

- **PostgreSQL** с поддержкой партиционирования
- **Таблицы:**
  - `instruments` - справочник инструментов
  - `candles` - исторические данные (партиционирована по месяцам)
  - `dividends` - данные о дивидендах
- **Индексы** для оптимизации запросов
- **Внешние ключи** для обеспечения целостности данных

## Требования

- Go 1.25+
- PostgreSQL 17+ (ниже версия тоже будет работать)
- Токен доступа к API Т-Инвестиций

## Установка

### 1. Клонирование репозитория

```bash
git clone https://github.com/motylkov/market-loader.git
cd market-loader
```

### 2. Установка зависимостей

```bash
go mod tidy
```

### 3. Настройка базы данных

#### 3.1. Создание пользователя

Создайте пользователя для работы с базой данных:

```sql
-- Создание пользователя
CREATE USER t_invest_user WITH PASSWORD 'your_secure_password';
```

#### 3.2. Создание базы данных

Создайте базу данных с владельцем:

```sql
-- Создание базы данных с владельцем
CREATE DATABASE t_invest_data OWNER t_invest_user;
```

#### 3.3. Настройка прав доступа

Предоставьте необходимые права пользователю:

```sql
-- Предоставление прав на подключение к базе данных
GRANT CONNECT ON DATABASE t_invest_data TO t_invest_user;

-- Предоставление всех прав на базу данных
GRANT ALL PRIVILEGES ON DATABASE t_invest_data TO t_invest_user;

-- Подключение к созданной базе данных
\c t_invest_data

-- Предоставление прав на схему public
GRANT ALL PRIVILEGES ON SCHEMA public TO t_invest_user;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO t_invest_user;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO t_invest_user;

-- Установка владельца схемы public
ALTER SCHEMA public OWNER TO t_invest_user;
```

### 4. Конфигурация

Скопируйте файл конфигурации:

```bash
cp config/config.example.yaml config/config.yaml
```

Отредактируйте `config/config.yaml`

## Сборка

### Сборка для текущей ОС

```bash
make
```

### Кросс-компиляция

```bash
# Windows
make build-windows

# Linux
make build-linux

# macOS
make build-darwin

# FreeBSD
make build-freebsd
```

### Сборка всех загрузчиков

```bash
make
```

## Использование

### 1. Загрузка инструментов

```bash
./bin/loader-instruments
```

### 2. Загрузка дивидендов

```bash
./bin/loader-dividends
```

### 3. Загрузка свечей - интервальные утилиты

```bash
# Загрузка данных по 1-минутным свечам
./bin/loader-1min

# Загрузка данных по дневным свечам
./bin/loader-1day

# И так далее для других интервалов
```

### 4. Быстрая загрузка через архивы (loader-arch)

```bash
# Загрузка минутных данных за несколько лет через архивы
./bin/loader-arch
```
Можно использовать для первоначального заполнения базы историческими данными, но нужно учитывать что это большое количество записей.

### 5. Визуализация

Для просмотра загруженных в БД данных можно использовать демонстрационный проект [Visualizer](https://github.com/motylkov/Visualizer). 

### Управление инструментами

По умолчанию все инструменты отключены для предотвращения загрузки больших объемов данных. Включите только нужные инструменты:

```sql
-- Включить конкретные тикеры
UPDATE instruments SET enabled = true 
WHERE ticker IN ('SBER', 'GAZP', 'LKOH', 'YNDX', 'TCSG')
  AND trading_status = 'SECURITY_TRADING_STATUS_NORMAL_TRADING';

-- Включить все акции определенной валюты
UPDATE instruments SET enabled = true 
WHERE instrument_type = 'share' AND currency = 'RUB'
  AND trading_status = 'SECURITY_TRADING_STATUS_NORMAL_TRADING';

-- Включить все ETF
UPDATE instruments SET enabled = true 
WHERE instrument_type = 'etf'
  AND trading_status = 'SECURITY_TRADING_STATUS_NORMAL_TRADING';
```

**Проверка состояния:**
```sql
-- Показать включенные инструменты
SELECT ticker, name, instrument_type, currency 
FROM instruments 
WHERE enabled = true 
ORDER BY instrument_type, ticker;

-- Статистика по типам
SELECT instrument_type, COUNT(*) as total, 
       COUNT(CASE WHEN enabled = true THEN 1 END) as enabled_count
FROM instruments 
WHERE trading_status = 'SECURITY_TRADING_STATUS_NORMAL_TRADING'
GROUP BY instrument_type;
```

Подробные примеры в файле `scripts/instruments.sql`

### Автоматизация

Настройте автоматический запуск через cron (Linux/macOS/BSD) или Планировщик задач (Windows), чтобы регулярно обновлять данные.


Выбирайте интервал свечей в зависимости от целей:

- Краткосрочная торговля / анализ → 1, 5, 15 минут
- Среднесрочный анализ → 1 час, 4 часа
- Долгосрочный анализ / визуализация → 1 день, 1 неделя, 1 месяц


### Сколько данных будет накоплено за год?

Чем короче интервал свечи — тем больше записей и больше объём данных. Ниже приведена таблица с оценкой количества свечей **на один инструмент за 365 дней**:

| Интервал     | Количество интервалов за год | Свечей за год  |
|--------------|------------------------------|----------------|
| 1 минута     | 525 600                      | ~ 250 000      |
| 5 минут      | 105 120                      | ~ 50 000       |
| 30 минут     | 17 520                       | ~ 8 000        |
| 1 час        | 8 760                        | ~ 4 000        |
| 2 часа       | 4 380                        | ~ 2 000        |

Данных о свечах меньше поскольку ночью торгов нет, есть выходные дни и ситуации связанные с остановкой торгов.


Выбирайте интервалы осознанно — чем больше данных, тем выше требования к хранилищу и производительности. 

```Совет
Если вы хотите построить мини-график за год (например, общую динамику цены), используйте ежемесячные свечи — всего 12 точек на инструмент. Это позволяет хранить данные очень компактно и быстро строить обзорные визуализации без нагрузки на БД. 
```

### Пример cron-задачи для ежедневной загрузки

```bash
# Загрузка 1-минутных свечей *
*/2 * * * * /path/to/loader-1min

# Загрузка дневных свечей раз в день в 20:00
0 20 * * * /path/to/loader-1day
```

## Структура базы данных

Описание схемы базы данных, таблиц, индексов и партиционирования находится в файле [DATABASE.md](DATABASE.md). Дополнительный SQL запросы можно найти в папке [scripts](/scripts).

## Логирование

Подробное описание настроек логирование находится в файле [LOGS.md](LOGS.md).


## Ограничения API

- Лимиты на количество запросов в единицу времени
- Ограничения на глубину исторических данных*
- Требования к аутентификации

## Устранение неполадок

### Ошибки подключения к БД

1. Проверьте настройки подключения в `config.yaml`
2. Убедитесь, что PostgreSQL запущен
3. Проверьте права доступа пользователя

### Ошибки API

1. Проверьте валидность токена
2. Убедитесь в наличии прав доступа к API
3. Проверьте лимиты запросов

### Ошибки партиционирования

1. Убедитесь, что таблица `candles` создана как партиционированная
2. Проверьте права на создание таблиц
3. Проверьте корректность дат в запросах

### *
Для загрузки больших периодов исторических данных с минутными интервалами обычную утилиту тоже можно использовать, но загрузка будет происходить дольше из-за лимитов. Лучше использовать `loader-arch`.

## Отказ от ответственности
Этот проект не связан АО «ТБанк». Названия элементов и API использованы исключительно в информационных целях.

Этот проект представляет собой инструмент для загрузки рыночных данных из API Т-Инвестиций и их хранения в локальной БД. Авторы и правообладатели не несут никакой ответственности за ваши торговые решения, финансовые потери, упущенную выгоду или любые другие убытки, прямо или косвенно связанные с использованием данного программного обеспечения. Вы должны полностью осознавать эти риски и 
иметь соответствующий опыт, прежде чем принимать какие-либо торговые решения. Вы самостоятельно несете ответственность за проведение собственного анализа.

- **НЕ является торговой системой** или финансовым советником

- **НЕ предоставляет инвестиционных рекомендаций**

- **НЕ гарантирует прибыльность** торговых операций

## Disclaimer
This project is a tool for downloading market data from the T-Investment API and storing it in a local database. The authors and copyright holders are not responsible for your trading decisions, financial losses, lost profits, or any other damages directly or indirectly related to the use of this software. You must be fully aware of these risks and have the appropriate experience before making any trading decisions. You are solely responsible for conducting your own analysis.


- **Is NOT a trading system** or financial advisor

- **Does NOT provide investment recommendations**

- **Does NOT guarantee profitability** of trading operations

## Лицензия

This project is licensed under the Mozilla Public License 2.0 (MPL-2.0) - see the [LICENSE](LICENSE) file for details.

Copyright (C) 2025 Maxim Motylkov
